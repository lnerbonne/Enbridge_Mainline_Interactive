<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Line MAINLINE_FULL Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link href="../libraries/maplibre-gl.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #basemap-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      padding: 8px 12px;
      background-color: white;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .maplibregl-popup {
      max-width: 400px;
      font-family: 'Bai Jamjuree', monospace;
      font-weight: 300;
      font-size: 14px;
      line-height: 1.5;
      color: #000;
      border-radius: 6px;
      border-left: 4px solid #ff0000;
      padding: 10px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      background-color: #fff;
    }

    .maplibregl-popup strong {
      font-family: 'Arial Black', Gadget, sans-serif;
      font-weight: 900;
      color: #ff0000;
    }

    .maplibregl-popup ul { margin: 6px 0 0 0; padding-left: 16px; }
    .maplibregl-popup li { margin-bottom: 4px; }

    .maplibregl-ctrl-group {
      transform: scale(1.5);
      transform-origin: top left;
    }
  </style>
</head>
<body>

<div id="map"></div>
<button id="basemap-toggle">Change Basemap</button>

<script src="../libraries/maplibre-gl.js"></script>
<script type="module" src="../libraries/pmtiles.js"></script>

<script type="module">
  import * as PMTiles from '../libraries/pmtiles.js';

  const protocol = new PMTiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const baseStyle = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json";
  const satelliteStyle = "https://api.maptiler.com/maps/streets-v2/style.json?key=l8m3YmmNE3GnNddhS5P8";

  const map = new maplibregl.Map({
    container: "map",
    style: baseStyle
  });

  map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-left');

  function addMAINLINE_FULL() {
    if (!map.getSource("MAINLINE_FULL")) {
      map.addSource("MAINLINE_FULL", {
        type: "vector",
        url: "pmtiles://../data/pmtiles/MAINLINE_FULL.pmtiles"
      });
    }

    if (!map.getLayer("MAINLINE_FULL-layer")) {
      map.addLayer({
        id: "MAINLINE_FULL-layer",
        type: "line",
        source: "MAINLINE_FULL",
        "source-layer": "MAINLINE_FULL",
        paint: { 
          "line-color": "red",
          "line-width": 2
        }
      });
    }

    if (!map.getLayer("MAINLINE_FULL-hitbox")) {
      map.addLayer({
        id: "MAINLINE_FULL-hitbox",
        type: "line",
        source: "MAINLINE_FULL",
        "source-layer": "MAINLINE_FULL",
        paint: { "line-color": "rgba(0,0,0,0.0)", "line-width": 30 }
      });
    }

    map.off("click", "MAINLINE_FULL-hitbox", onClickMAINLINE_FULL);
    map.on("click", "MAINLINE_FULL-hitbox", onClickMAINLINE_FULL);

    map.off("mousemove", "MAINLINE_FULL-hitbox");
    map.on("mousemove", "MAINLINE_FULL-hitbox", () => {
      map.setPaintProperty("MAINLINE_FULL-layer", "line-width", 8);
      map.getCanvas().style.cursor = "pointer";
    });

    map.off("mouseleave", "MAINLINE_FULL-hitbox");
    map.on("mouseleave", "MAINLINE_FULL-hitbox", () => {
      map.setPaintProperty("MAINLINE_FULL-layer", "line-width", 2);
      map.getCanvas().style.cursor = "";
    });
  }

  map.once("idle", () => {
      const features = map.querySourceFeatures("MAINLINE_FULL", { sourceLayer: "MAINLINE_FULL" });
      if (features.length > 0) {
        const bounds = new maplibregl.LngLatBounds();
        features.forEach(f => {
          const coords = f.geometry.coordinates.flat(Infinity);
          for (let i = 0; i < coords.length; i += 2) {
            bounds.extend([coords[i], coords[i + 1]]);
          }
        });
        map.fitBounds(bounds, { padding: 50, duration: 0});
      }
    });
  

function onClickMAINLINE_FULL(e) {
  if (e.features && e.features.length > 0) {
    const features = e.features;
    const lngLat = e.lngLat;
    let currentPopup = null;

    function showFeatureList() {

      // If there's only one feature, show its details directly
      if (features.length === 1) {
        showFeatureDetails(0);
        return;
      }

      let html = `<div class="popup-content" id="feature-list">
                    <div>`;
      
      features.forEach((f, i) => {
        const label = f.properties.Name || `Feature ${i + 1}`;
        html += `<button 
                  data-feature-index="${i}"
                  style="width:100%; margin:3px 0; padding:8px; 
                  background:#f8f8f8; border:1px solid #ddd; 
                  border-radius:4px; cursor:pointer; text-align:left;">
                  ${label}
                </button>`;
      });

      html += `</div></div>`;

      if (currentPopup) currentPopup.remove();
      currentPopup = new maplibregl.Popup({ closeButton: true, closeOnClick: true })
        .setLngLat(lngLat)
        .setHTML(html)
        .addTo(map);

      // Add click handlers after popup is added to DOM
      const container = document.getElementById('feature-list');
      if (container) {
        container.addEventListener('click', (event) => {
          const button = event.target.closest('button');
          if (button) {
            const idx = parseInt(button.dataset.featureIndex, 10);
            showFeatureDetails(idx);
          }
        });
      }
    }

    function showFeatureDetails(idx) {
      if (idx < 0 || idx >= features.length) return;

      const props = features[idx].properties;
      let html = `<div class="popup-content" id="feature-details">
                    <strong>${props.Name || 'Feature Details'}</strong>
                    <ul style="margin-top:10px;">`;
      
      for (const key in props) {
        if (key.toLowerCase() !== "id") {
          html += `<li><strong>${key}:</strong> ${props[key]}</li>`;
        }
      }
      
      html += `</ul>`;
      
      // Only add the back button if there are multiple features
      if (features.length > 1) {
        html += `<button 
                  id="back-to-list"
                  style="width:100%; margin-top:10px; padding:8px; 
                  background:#f8f8f8; border:1px solid #ddd; 
                  border-radius:4px; cursor:pointer;">
                  ‚Üê Back to feature list
                </button>`;
      }
      
      html += `</div>`;

      if (currentPopup) currentPopup.remove();
      currentPopup = new maplibregl.Popup({ closeButton: true, closeOnClick: true })
        .setLngLat(lngLat)
        .setHTML(html)
        .addTo(map);

      // Add click handler for back button after popup is added to DOM
      const backButton = document.getElementById('back-to-list');
      if (backButton) {
        backButton.addEventListener('click', showFeatureList);
      }
    }

    // Show initial feature list
    showFeatureList();
  }
}

  map.on("load", addMAINLINE_FULL);

  const toggleButton = document.getElementById("basemap-toggle");
  toggleButton.onclick = () => {
    const current = map.getStyle().sprite.includes("cartocdn") ? satelliteStyle : baseStyle;
    map.setStyle(current);
    map.once("styledata", () => setTimeout(addMAINLINE_FULL, 200));
  };
</script>

</body>
</html>