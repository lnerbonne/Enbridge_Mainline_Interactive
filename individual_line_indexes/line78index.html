<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Line 78 Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link href="../libraries/maplibre-gl.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #basemap-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      padding: 8px 12px;
      background-color: white;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .maplibregl-popup {
      max-width: 400px;
      font-family: 'Bai Jamjuree', monospace;
      font-weight: 300;
      font-size: 14px;
      line-height: 1.5;
      color: #000;
      border-radius: 6px;
      border-left: 4px solid #ff0000;
      padding: 10px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      background-color: #fff;
    }

    .maplibregl-popup strong {
      font-family: 'Arial Black', Gadget, sans-serif;
      font-weight: 900;
      color: #ff0000;
    }

    .maplibregl-popup ul { margin: 6px 0 0 0; padding-left: 16px; }
    .maplibregl-popup li { margin-bottom: 4px; }

    .maplibregl-ctrl-group {
      transform: scale(1.5);
      transform-origin: top left;
    }
  </style>
</head>
<body>

<div id="map"></div>
<button id="basemap-toggle">Change Basemap</button>

<script src="../libraries/maplibre-gl.js"></script>
<script type="module" src="../libraries/pmtiles.js"></script>

<script type="module">
  import * as PMTiles from '../libraries/pmtiles.js';

  const protocol = new PMTiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const baseStyle = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json";
  const satelliteStyle = "https://api.maptiler.com/maps/streets-v2/style.json?key=l8m3YmmNE3GnNddhS5P8";

  const map = new maplibregl.Map({
    container: "map",
    style: baseStyle
  });

  map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-left');

  function addLine78() {
    if (!map.getSource("line78")) {
      map.addSource("line78", {
        type: "vector",
        url: "pmtiles://../data/pmtiles/line78.pmtiles"
      });
    }

    if (!map.getLayer("line78-layer")) {
      map.addLayer({
        id: "line78-layer",
        type: "line",
        source: "line78",
        "source-layer": "78",
        paint: { "line-color": "red", "line-width": 2 }
      });
    }

    if (!map.getLayer("line78-hitbox")) {
      map.addLayer({
        id: "line78-hitbox",
        type: "line",
        source: "line78",
        "source-layer": "78",
        paint: { "line-color": "rgba(0,0,0,0.01)", "line-width": 30 }
      });
    }

    map.off("click", "line78-hitbox", onClickLine78);
    map.on("click", "line78-hitbox", onClickLine78);

    map.off("mousemove", "line78-hitbox");
    map.on("mousemove", "line78-hitbox", () => {
      map.setPaintProperty("line78-layer", "line-width", 8);
      map.getCanvas().style.cursor = "pointer";
    });

    map.off("mouseleave", "line78-hitbox");
    map.on("mouseleave", "line78-hitbox", () => {
      map.setPaintProperty("line78-layer", "line-width", 2);
      map.getCanvas().style.cursor = "";
    });
  }

  map.once("idle", () => {
      const features = map.querySourceFeatures("line78", { sourceLayer: "78" });
      if (features.length > 0) {
        const bounds = new maplibregl.LngLatBounds();
        features.forEach(f => {
          const coords = f.geometry.coordinates.flat(Infinity);
          for (let i = 0; i < coords.length; i += 2) {
            bounds.extend([coords[i], coords[i + 1]]);
          }
        });
        map.fitBounds(bounds, { padding: 50, duration: 0});
      }
    });
  

  function onClickLine78(e) {
    if (e.features && e.features.length > 0) {
      const props = e.features[0].properties;
      let html = `<div class="popup-content"><ul>`;
      for (const key in props) {
        if (key.toLowerCase() !== "id") {
          html += `<li><strong>${key}:</strong> ${props[key]}</li>`;
        }
      }
      html += `</ul></div>`;

      new maplibregl.Popup({ closeButton: true, closeOnClick: true, offset: { 
        'top': [100, 50],
        'bottom': [100, -50],
        'left': [150, 0],
        'right': [50, 0]
      } })
        .setLngLat(e.lngLat)
        .setHTML(html)
        .addTo(map);
    }
  }

  map.on("load", addLine78);

  const toggleButton = document.getElementById("basemap-toggle");
  toggleButton.onclick = () => {
    const current = map.getStyle().sprite.includes("cartocdn") ? satelliteStyle : baseStyle;
    map.setStyle(current);
    map.once("styledata", () => setTimeout(addLine78, 200));
  };
</script>

</body>
</html>