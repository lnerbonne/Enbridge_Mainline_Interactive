<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Enbridge Mainline Map</title>
  <meta name="viewport" content="width=device-width, in      features.forEach((f, i) => {
      const label = f.properties.Name || `Line ${f.properties.Line || (i + 1)}`;
      html += `<button 
                data-feature-index="${i}"
                class="feature-select-button">
                ${label}
              </button>`;le=1.0" />
  
  <link href="../libraries/maplibre-gl.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #basemap-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      padding: 8px 12px;
      background-color: white;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .maplibregl-popup {
      max-width: 400px;
      font-family: 'Bai Jamjuree', monospace;
      font-weight: 300;
      font-size: 14px;
      line-height: 1.5;
      color: #000;
      border-radius: 6px;
      border-left: 4px solid #ff0000;
      padding: 10px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      background-color: #fff;
    }

    .maplibregl-popup strong {
      font-family: 'Arial Black', Gadget, sans-serif;
      font-weight: 900;
      color: #ff0000;
    }

    .maplibregl-popup ul { margin: 6px 0 0 0; padding-left: 16px; }
    .maplibregl-popup li { margin-bottom: 4px; }

    .maplibregl-ctrl-group {
      transform: scale(1.5);
      transform-origin: top left;
    }

    .feature-select-button {
      width: 100%;
      margin: 3px 0;
      padding: 8px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      text-align: left;
      font-family: 'Arial Black', Gadget, sans-serif;
      font-weight: 900;
      color: #000000;
    }
  </style>
</head>
<body>

<div id="map"></div>
<button id="basemap-toggle">Change Basemap</button>

<script src="../libraries/maplibre-gl.js"></script>
<script type="module" src="../libraries/pmtiles.js"></script>

<script type="module">
  import * as PMTiles from '../libraries/pmtiles.js';

  const protocol = new PMTiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const baseStyle = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json";
  const satelliteStyle = "https://api.maptiler.com/maps/streets-v2/style.json?key=l8m3YmmNE3GnNddhS5P8";

  const map = new maplibregl.Map({
    container: "map",
    style: baseStyle,
    scrollZoom: false
  });

  map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-left');

  // Define all line numbers
  const lineNumbers = ['1', '2', '3', '4', '5', '6', '7', '11', '14_64', '61', '62', '65', '67', '78'];
  let currentPopup = null;

  function addLine(lineNum) {
    const sourceId = `line${lineNum}`;
    const layerId = `line${lineNum}-layer`;
    const hitboxId = `line${lineNum}-hitbox`;

    // Add source if it doesn't exist
    if (!map.getSource(sourceId)) {
      map.addSource(sourceId, {
        type: "vector",
        url: `pmtiles://../data/pmtiles/line${lineNum}.pmtiles`
      });
    }

    // Add visible line layer
    if (!map.getLayer(layerId)) {
      map.addLayer({
        id: layerId,
        type: "line",
        source: sourceId,
        "source-layer": lineNum,
        paint: { 
          "line-color": "red",
          "line-width": 2
        }
      });
    }

    // Add invisible wider hitbox for better interaction
    if (!map.getLayer(hitboxId)) {
      map.addLayer({
        id: hitboxId,
        type: "line",
        source: sourceId,
        "source-layer": lineNum,
        paint: { 
          "line-color": "rgba(0,0,0,0.0)",
          "line-width": 30
        }
      });
    }

    // Add hover effect
    map.on("mousemove", hitboxId, () => {
      map.setPaintProperty(layerId, "line-width", 8);
      map.getCanvas().style.cursor = "pointer";
    });

    map.on("mouseleave", hitboxId, () => {
      map.setPaintProperty(layerId, "line-width", 2);
      map.getCanvas().style.cursor = "";
    });

    // Add click handler
    map.on("click", hitboxId, (e) => {
      if (e.features && e.features.length > 0) {
        // Get all features at the clicked point from all layers
        const features = lineNumbers.reduce((allFeatures, lineNum) => {
          const layerFeatures = map.queryRenderedFeatures(e.point, {
            layers: [`line${lineNum}-hitbox`]
          });
          // Only take the first feature from each line (since they're identical)
          return layerFeatures.length > 0 ? 
            [...allFeatures, layerFeatures[0]] : 
            allFeatures;
        }, []);

        if (features.length === 1) {
          showPopup(features[0], e.lngLat);
        } else if (features.length > 1) {
          showFeatureList(features, e.lngLat);
        }
      }
    });
  }

  function showFeatureList(features, lngLat) {
    if (currentPopup) currentPopup.remove();

    let html = `<div class="popup-content" id="feature-list">
                  <div>`;
    
    features.forEach((f, i) => {
      const label = f.properties.Name || `Line ${f.properties.Line || (i + 1)}`;
      html += `<button 
                data-feature-index="${i}"
                style="width:100%; margin:3px 0; padding:8px; 
                background:#f8f8f8; border:1px solid #ddd; 
                border-radius:4px; cursor:pointer; text-align:left;
                font-family: 'Arial Black', Gadget, sans-serif;
                font-weight: 900;
                color: #ff0000">
                ${label}
              </button>`;
    });

    html += `</div></div>`;

    currentPopup = new maplibregl.Popup({ closeButton: true, closeOnClick: true })
      .setLngLat(lngLat)
      .setHTML(html)
      .addTo(map);

    // Add click handlers after popup is added to DOM
    const container = document.getElementById('feature-list');
    if (container) {
      container.addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (button) {
          const idx = parseInt(button.dataset.featureIndex, 10);
          showPopup(features[idx], lngLat);
        }
      });
    }
  }

  function showPopup(feature, lngLat) {
    if (currentPopup) currentPopup.remove();

    const props = feature.properties;
    let html = `<div class="popup-content" id="feature-details">
                  <strong>${props.Name || 'Line Details'}</strong>
                  <ul style="margin-top:10px;">`;
    
    for (const key in props) {
      if (key.toLowerCase() !== "id") {
        html += `<li><strong>${key}:</strong> ${props[key]}</li>`;
      }
    }
    
    html += `</ul>`;

    // Only add back button if we have multiple features at this point
    const featuresAtPoint = lineNumbers.reduce((allFeatures, lineNum) => {
      const layerFeatures = map.queryRenderedFeatures(map.project(lngLat), {
        layers: [`line${lineNum}-hitbox`]
      });
      // Only take the first feature from each line (since they're identical)
      return layerFeatures.length > 0 ? 
        [...allFeatures, layerFeatures[0]] : 
        allFeatures;
    }, []);

    if (featuresAtPoint.length > 1) {
      html += `<button 
                id="back-to-list"
                style="width:100%; margin-top:10px; padding:8px; 
                background:#f8f8f8; border:1px solid #ddd; 
                border-radius:4px; cursor:pointer;">
                ‚Üê Back to feature list
              </button>`;
    }

    html += `</div>`;

    currentPopup = new maplibregl.Popup({ closeButton: true, closeOnClick: true })
      .setLngLat(lngLat)
      .setHTML(html)
      .addTo(map);

    // Add click handler for back button
    const backButton = document.getElementById('back-to-list');
    if (backButton) {
      backButton.addEventListener('click', () => {
        showFeatureList(featuresAtPoint, lngLat);
      });
    }
  }

  map.on("load", () => {
    // Add all lines
    lineNumbers.forEach(addLine);

    // Set initial bounds to show Edmonton to Toronto
    const bounds = new maplibregl.LngLatBounds(
      [-113.5234, 43.6532],  // Southwest (Edmonton area)
      [-79.3832, 53.5461]    // Northeast (Toronto area)
    );
    map.fitBounds(bounds, { padding: 50, duration: 0 });
  });

  // Handle basemap toggle
  const toggleButton = document.getElementById("basemap-toggle");
  toggleButton.onclick = () => {
    const current = map.getStyle().sprite.includes("cartocdn") ? satelliteStyle : baseStyle;
    map.setStyle(current);
    map.once("styledata", () => {
      // Re-add all lines after style change
      lineNumbers.forEach(addLine);
    });
  };
</script>

</body>
</html>
